<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JD Management | Matcher</title>
  <link rel="stylesheet" href="/assets/css/shared.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* Filter Bar */
    .filter-bar {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .filter-bar input {
      flex: 1;
      min-width: 200px;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 0.8125rem;
    }

    .filter-bar input:focus {
      outline: none;
      border-color: var(--gray-900);
    }

    /* Table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      text-align: left;
      padding: 0.75rem 1rem;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
      border-bottom: 1px solid var(--gray-200);
      white-space: nowrap;
    }

    .data-table td {
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      color: var(--gray-700);
      border-bottom: 1px solid var(--gray-100);
    }

    .data-table tbody tr:hover {
      background: var(--gray-50);
    }

    .jd-name {
      font-weight: 500;
      color: var(--gray-900);
    }

    .meta-tag {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      background: var(--gray-100);
      border-radius: 4px;
      font-size: 0.6875rem;
      color: var(--gray-600);
      margin-right: 0.25rem;
    }

    .criteria-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .criteria-tag {
      display: inline-block;
      padding: 0.125rem 0.375rem;
      background: var(--gray-900);
      color: white;
      border-radius: 3px;
      font-size: 0.625rem;
    }

    .criteria-more {
      color: var(--gray-500);
      font-size: 0.6875rem;
    }

    .action-btn {
      padding: 0.375rem 0.625rem;
      background: none;
      border: 1px solid var(--gray-300);
      border-radius: 4px;
      cursor: pointer;
      color: var(--gray-600);
      font-size: 0.75rem;
      margin-left: 0.25rem;
    }

    .action-btn:hover {
      background: var(--gray-100);
    }

    .action-btn.danger:hover {
      background: #fee2e2;
      border-color: #fecaca;
      color: #dc2626;
    }

    /* Pagination */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .pagination-info {
      font-size: 0.8125rem;
      color: var(--gray-600);
    }

    .pagination-nav {
      display: flex;
      gap: 0.25rem;
    }

    .pagination-btn {
      min-width: 2rem;
      height: 2rem;
      padding: 0 0.5rem;
      border: 1px solid var(--gray-300);
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8125rem;
      color: var(--gray-700);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .pagination-btn:hover:not(:disabled) {
      background: var(--gray-100);
    }

    .pagination-btn.active {
      background: var(--gray-900);
      color: white;
      border-color: var(--gray-900);
    }

    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Modal */
    .drop-zone {
      border: 2px dashed var(--gray-300);
      border-radius: 6px;
      padding: 2.5rem 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .drop-zone:hover {
      border-color: var(--gray-400);
      background: var(--gray-50);
    }

    .drop-zone i {
      font-size: 2rem;
      color: var(--gray-400);
      margin-bottom: 0.75rem;
    }

    /* Criteria Editor */
    .criteria-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      min-height: 100px;
      padding: 1rem;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .criteria-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.375rem 0.75rem;
      background: var(--gray-900);
      color: white;
      border-radius: 4px;
      font-size: 0.8125rem;
    }

    .criteria-chip button {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      padding: 0;
      font-size: 0.875rem;
    }

    .criteria-chip button:hover {
      color: white;
    }

    .criteria-input-row {
      display: flex;
      gap: 0.5rem;
    }

    .criteria-input-row input {
      flex: 1;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 0.875rem;
    }

    .criteria-input-row input:focus {
      outline: none;
      border-color: var(--gray-900);
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <i class="bi bi-diagram-3"></i>
          Matcher
        </a>
      </div>
      <nav class="sidebar-nav">
        <a href="/" class="nav-item">
          <i class="bi bi-bar-chart"></i>
          <span>Compare</span>
        </a>
        <a href="/jd-management.html" class="nav-item active">
          <i class="bi bi-file-earmark-text"></i>
          <span>JD Management</span>
        </a>
        <a href="/cv-management.html" class="nav-item">
          <i class="bi bi-person-badge"></i>
          <span>CV Management</span>
        </a>
        <a href="/history.html" class="nav-item">
          <i class="bi bi-clock-history"></i>
          <span>History</span>
        </a>
        <div style="flex: 1;"></div>
        <a href="#" class="nav-item" onclick="openAiSettingsModal()">
          <i class="bi bi-gear"></i>
          <span>AI Settings</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <header class="header">
        <button class="mobile-menu-toggle" onclick="toggleSidebar()">
          <i class="bi bi-list"></i>
        </button>
        <h1 class="header-title">Job Descriptions</h1>
        <div class="header-toolbar">
          <button class="btn btn-primary" onclick="openUploadModal()">
            <i class="bi bi-upload"></i>
            Upload
          </button>
        </div>
      </header>

      <!-- Content -->
      <main class="content">
        <!-- Filter -->
        <div class="filter-bar">
          <input type="text" id="searchInput" placeholder="Search job descriptions..." oninput="applyFilters()">
        </div>

        <!-- Table -->
        <div class="card">
          <div style="overflow-x: auto;">
            <table class="data-table">
              <thead>
                <tr>
                  <th>JD Name</th>
                  <th>Category</th>
                  <th>Department</th>
                  <th>Criteria</th>
                  <th style="text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr>
                  <td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-400);">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="pagination" class="pagination hidden"></div>
        </div>
      </main>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="uploadModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
      <div style="padding: 1.25rem; border-bottom: 1px solid var(--gray-200);">
        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">Upload JDs</h3>
      </div>
      <div style="padding: 1.5rem;">
        <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
          <input type="file" id="fileInput" accept=".pdf,.docx" multiple style="display: none;">
          <i class="bi bi-cloud-arrow-up"></i>
          <p style="margin: 0;"><strong>Drop files here</strong> or click to browse</p>
          <p style="font-size: 0.75rem; color: var(--gray-400); margin: 0.5rem 0 0;">.pdf, .docx</p>
        </div>
      </div>
      <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-200); text-align: right;">
        <button class="btn btn-outline" onclick="closeUploadModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div style="padding: 1.25rem; border-bottom: 1px solid var(--gray-200);">
        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">Edit JD: <span id="editJDName"></span></h3>
      </div>
      <div style="padding: 1.5rem;">
        <input type="hidden" id="editingJD">
        
        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); margin-bottom: 0.375rem;">Category</label>
          <input type="text" id="editCategory" class="form-control" placeholder="e.g., Engineering">
        </div>
        
        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); margin-bottom: 0.375rem;">Department</label>
          <input type="text" id="editDepartment" class="form-control" placeholder="e.g., IT">
        </div>
      </div>
      <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-200); display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveEdit()">Save</button>
      </div>
    </div>
  </div>

  <!-- Criteria Modal -->
  <div id="criteriaModal" class="modal">
    <div class="modal-content" style="max-width: 550px;">
      <div style="padding: 1.25rem; border-bottom: 1px solid var(--gray-200);">
        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">
          Evaluation Criteria: <span id="criteriaJDName"></span>
        </h3>
      </div>
      <div style="padding: 1.5rem;">
        <input type="hidden" id="editingCriteriaJD">
        
        <div class="criteria-container" id="criteriaContainer">
          <!-- Chips will be rendered here -->
        </div>
        
        <div class="criteria-input-row">
          <input type="text" id="newCriteriaInput" placeholder="Add new criteria..." onkeydown="if(event.key === 'Enter') addCriteria()">
          <button class="btn btn-primary" onclick="addCriteria()">Add</button>
        </div>
        
        <p style="font-size: 0.75rem; color: var(--gray-500); margin: 0.75rem 0 0;">
          These criteria will be used by AI to evaluate candidates.
        </p>
      </div>
      <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-200); display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button class="btn btn-outline" onclick="closeCriteriaModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCriteria()">Save</button>
      </div>
    </div>
  </div>

  <script>
    let allJDs = [];
    let filteredJDs = [];
    let currentPage = 1;
    let pageSize = 15;
    let currentCriteria = [];

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    function openUploadModal() {
      document.getElementById('uploadModal').classList.add('active');
    }

    function closeUploadModal() {
      document.getElementById('uploadModal').classList.remove('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    function closeCriteriaModal() {
      document.getElementById('criteriaModal').classList.remove('active');
    }

    async function loadJDs() {
      try {
        const res = await fetch('/jds');
        const data = await res.json();
        allJDs = data.items || [];
        applyFilters();
      } catch (e) {
        document.getElementById('tableBody').innerHTML = `
          <tr><td colspan="5" style="text-align: center; padding: 2rem; color: #dc2626;">Error loading data</td></tr>
        `;
      }
    }

    // Normalize Vietnamese text for search (remove diacritics)
    function normalizeVietnamese(str) {
      return str
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/đ/g, 'd')
        .replace(/Đ/g, 'D');
    }

    function applyFilters() {
      const search = document.getElementById('searchInput').value;
      const normalizedSearch = normalizeVietnamese(search);
      filteredJDs = allJDs.filter(jd => {
        if (normalizedSearch && !normalizeVietnamese(jd.name).includes(normalizedSearch)) return false;
        return true;
      });
      currentPage = 1;
      renderTable();
    }

    function renderTable() {
      const start = (currentPage - 1) * pageSize;
      const pageItems = filteredJDs.slice(start, start + pageSize);
      const tbody = document.getElementById('tableBody');

      if (pageItems.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-400);">No JDs found</td></tr>
        `;
        document.getElementById('pagination').classList.add('hidden');
        return;
      }

      tbody.innerHTML = pageItems.map(jd => {
        const criteria = jd.criteria || [];
        const displayCriteria = criteria.slice(0, 3);
        const moreCriteria = criteria.length > 3 ? criteria.length - 3 : 0;
        
        return `
          <tr>
            <td><span class="jd-name">${jd.name}</span></td>
            <td>${jd.category ? `<span class="meta-tag">${jd.category}</span>` : '-'}</td>
            <td>${jd.department ? `<span class="meta-tag">${jd.department}</span>` : '-'}</td>
            <td>
              <div class="criteria-tags">
                ${displayCriteria.map(c => `<span class="criteria-tag">${c}</span>`).join('')}
                ${moreCriteria > 0 ? `<span class="criteria-more">+${moreCriteria}</span>` : ''}
                ${criteria.length === 0 ? '-' : ''}
              </div>
            </td>
            <td style="text-align: right; white-space: nowrap;">
              <button class="action-btn" onclick="openEditModal('${jd.name}')" title="Edit">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="action-btn" onclick="openCriteriaModal('${jd.name}')" title="Criteria">
                <i class="bi bi-list-check"></i>
              </button>
              <button class="action-btn danger" onclick="deleteJD('${jd.name}')" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');

      renderPagination();
    }

    function renderPagination() {
      const total = filteredJDs.length;
      const pages = Math.ceil(total / pageSize);

      if (pages <= 1) {
        document.getElementById('pagination').classList.add('hidden');
        return;
      }

      const start = (currentPage - 1) * pageSize + 1;
      const end = Math.min(currentPage * pageSize, total);

      let pagesHTML = '';
      for (let i = 1; i <= Math.min(pages, 5); i++) {
        pagesHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      }

      document.getElementById('pagination').classList.remove('hidden');
      document.getElementById('pagination').innerHTML = `
        <div class="pagination-info">${start}-${end} of ${total}</div>
        <div class="pagination-nav">
          <button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="bi bi-chevron-left"></i>
          </button>
          ${pagesHTML}
          <button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === pages ? 'disabled' : ''}>
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      `;
    }

    function goToPage(page) {
      currentPage = page;
      renderTable();
    }

    function openEditModal(name) {
      const jd = allJDs.find(j => j.name === name);
      if (!jd) return;

      document.getElementById('editModal').classList.add('active');
      document.getElementById('editJDName').textContent = name;
      document.getElementById('editingJD').value = name;
      document.getElementById('editCategory').value = jd.category || '';
      document.getElementById('editDepartment').value = jd.department || '';
    }

    async function saveEdit() {
      const name = document.getElementById('editingJD').value;
      const category = document.getElementById('editCategory').value;
      const department = document.getElementById('editDepartment').value;

      try {
        if (category) await updateJD(name, 'category', category);
        if (department) await updateJD(name, 'department', department);
        closeEditModal();
        loadJDs();
      } catch (e) {
        alert('Save failed');
      }
    }

    function openCriteriaModal(name) {
      const jd = allJDs.find(j => j.name === name);
      if (!jd) return;

      document.getElementById('criteriaModal').classList.add('active');
      document.getElementById('criteriaJDName').textContent = name;
      document.getElementById('editingCriteriaJD').value = name;
      currentCriteria = [...(jd.criteria || [])];
      renderCriteria();
    }

    function renderCriteria() {
      const container = document.getElementById('criteriaContainer');
      if (currentCriteria.length === 0) {
        container.innerHTML = '<p style="color: var(--gray-400); font-size: 0.875rem; margin: 0;">No criteria yet</p>';
        return;
      }
      container.innerHTML = currentCriteria.map((c, i) => `
        <div class="criteria-chip">
          <span>${c}</span>
          <button onclick="removeCriteria(${i})">&times;</button>
        </div>
      `).join('');
    }

    function addCriteria() {
      const input = document.getElementById('newCriteriaInput');
      const value = input.value.trim();
      if (value && !currentCriteria.includes(value)) {
        currentCriteria.push(value);
        renderCriteria();
        input.value = '';
      }
    }

    function removeCriteria(index) {
      currentCriteria.splice(index, 1);
      renderCriteria();
    }

    async function saveCriteria() {
      const name = document.getElementById('editingCriteriaJD').value;
      try {
        await updateJD(name, 'criteria', currentCriteria);
        closeCriteriaModal();
        loadJDs();
      } catch (e) {
        alert('Save failed');
      }
    }

    async function updateJD(name, field, value) {
      await fetch(`/jds/${encodeURIComponent(name)}/metadata`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ [field]: value })
      });
    }

    async function deleteJD(name) {
      if (!confirm(`Delete "${name}"?`)) return;
      try {
        await fetch(`/jds/${encodeURIComponent(name)}`, { method: 'DELETE' });
        loadJDs();
      } catch (e) {
        alert('Delete failed');
      }
    }

    // Drag & Drop
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = 'var(--gray-900)';
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.style.borderColor = 'var(--gray-300)';
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = 'var(--gray-300)';
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    async function handleFiles(files) {
      for (const file of files) {
        const formData = new FormData();
        formData.append('file', file);
        try {
          await fetch('/jds/upload', { method: 'POST', body: formData });
        } catch (e) {}
      }
      closeUploadModal();
      loadJDs();
    }

    loadJDs();
  </script>
  <script src="/assets/js/settings.js?v=2"></script>
</body>
</html>
