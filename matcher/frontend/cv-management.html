<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CV Management | Matcher</title>
  <link rel="stylesheet" href="/assets/css/shared.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* Filter Bar */
    .filter-bar {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .filter-bar input,
    .filter-bar select {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 0.8125rem;
    }

    .filter-bar input:focus,
    .filter-bar select:focus {
      outline: none;
      border-color: var(--gray-900);
    }

    .filter-bar input {
      flex: 1;
      min-width: 200px;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }

    .data-table th {
      text-align: left;
      padding: 0.75rem 1rem;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
      border-bottom: 1px solid var(--gray-200);
      white-space: nowrap;
    }

    .data-table td {
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      color: var(--gray-700);
      border-bottom: 1px solid var(--gray-100);
    }

    .data-table tbody tr:hover {
      background: var(--gray-50);
    }

    .cv-name {
      font-weight: 500;
      color: var(--gray-900);
    }

    .meta-tag {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      background: var(--gray-100);
      border-radius: 4px;
      font-size: 0.6875rem;
      color: var(--gray-600);
    }

    .status-badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 4px;
      font-size: 0.6875rem;
      font-weight: 500;
    }

    .status-badge.evaluated {
      background: #dcfce7;
      color: #16a34a;
    }

    .status-badge.not-evaluated {
      background: var(--gray-100);
      color: var(--gray-600);
    }

    .score-badge {
      font-weight: 600;
      font-size: 0.875rem;
    }

    .score-badge.high { color: #16a34a; }
    .score-badge.medium { color: #ca8a04; }
    .score-badge.low { color: #dc2626; }

    .jd-list {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      max-width: 200px;
    }

    .jd-item {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      background: var(--gray-50);
      border-radius: 4px;
      border-left: 2px solid var(--gray-400);
    }

    .action-btn {
      padding: 0.375rem 0.625rem;
      background: none;
      border: 1px solid var(--gray-300);
      border-radius: 4px;
      cursor: pointer;
      color: var(--gray-600);
      font-size: 0.75rem;
      margin-left: 0.25rem;
    }

    .action-btn:hover {
      background: var(--gray-100);
    }

    .action-btn.danger:hover {
      background: #fee2e2;
      border-color: #fecaca;
      color: #dc2626;
    }

    /* Pagination */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .pagination-info {
      font-size: 0.8125rem;
      color: var(--gray-600);
    }

    .pagination-nav {
      display: flex;
      gap: 0.25rem;
    }

    .pagination-btn {
      min-width: 2rem;
      height: 2rem;
      padding: 0 0.5rem;
      border: 1px solid var(--gray-300);
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8125rem;
      color: var(--gray-700);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .pagination-btn:hover:not(:disabled) {
      background: var(--gray-100);
    }

    .pagination-btn.active {
      background: var(--gray-900);
      color: white;
      border-color: var(--gray-900);
    }

    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Modal */
    .drop-zone {
      border: 2px dashed var(--gray-300);
      border-radius: 6px;
      padding: 2.5rem 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .drop-zone:hover {
      border-color: var(--gray-400);
      background: var(--gray-50);
    }

    .drop-zone i {
      font-size: 2rem;
      color: var(--gray-400);
      margin-bottom: 0.75rem;
    }

    /* Analysis Stats */
    .analysis-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .analysis-stat {
      text-align: center;
      padding: 1rem;
      background: var(--gray-50);
      border-radius: 6px;
    }

    .analysis-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gray-900);
    }

    .analysis-stat-label {
      font-size: 0.6875rem;
      color: var(--gray-500);
      text-transform: uppercase;
      margin-top: 0.25rem;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <i class="bi bi-diagram-3"></i>
          Matcher
        </a>
      </div>
      <nav class="sidebar-nav">
        <a href="/" class="nav-item">
          <i class="bi bi-bar-chart"></i>
          <span>Compare</span>
        </a>
        <a href="/jd-management.html" class="nav-item">
          <i class="bi bi-file-earmark-text"></i>
          <span>JD Management</span>
        </a>
        <a href="/cv-management.html" class="nav-item active">
          <i class="bi bi-person-badge"></i>
          <span>CV Management</span>
        </a>
        <a href="/history.html" class="nav-item">
          <i class="bi bi-clock-history"></i>
          <span>History</span>
        </a>
        <div style="flex: 1;"></div>
        <a href="#" class="nav-item" onclick="openAiSettingsModal()">
          <i class="bi bi-gear"></i>
          <span>AI Settings</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <header class="header">
        <button class="mobile-menu-toggle" onclick="toggleSidebar()">
          <i class="bi bi-list"></i>
        </button>
        <h1 class="header-title">CV Management</h1>
        <div class="header-toolbar">
          <button class="btn btn-primary" onclick="openUploadModal()">
            <i class="bi bi-upload"></i>
            Upload
          </button>
        </div>
      </header>

      <!-- Content -->
      <main class="content">
        <!-- Filter -->
        <div class="filter-bar">
          <input type="text" id="searchInput" placeholder="Search CVs..." oninput="applyFilters()">
          <select id="statusFilter" onchange="applyFilters()">
            <option value="">All Status</option>
            <option value="evaluated">Evaluated</option>
            <option value="not_evaluated">Not Evaluated</option>
          </select>
        </div>

        <!-- Table -->
        <div class="card">
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>CV Name</th>
                  <th>Category</th>
                  <th>Department</th>
                  <th>Contact</th>
                  <th>Status</th>
                  <th>Evaluations</th>
                  <th>Best Score</th>
                  <th style="text-align: right;">Actions</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr>
                  <td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray-400);">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="pagination" class="pagination hidden"></div>
        </div>
      </main>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="uploadModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
      <div style="padding: 1.25rem; border-bottom: 1px solid var(--gray-200);">
        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">Upload CVs</h3>
      </div>
      <div style="padding: 1.5rem;">
        <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
          <input type="file" id="fileInput" accept=".pdf,.docx" multiple style="display: none;">
          <i class="bi bi-cloud-arrow-up"></i>
          <p style="margin: 0;"><strong>Drop files here</strong> or click to browse</p>
          <p style="font-size: 0.75rem; color: var(--gray-400); margin: 0.5rem 0 0;">.pdf, .docx</p>
        </div>
      </div>
      <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-200); text-align: right;">
        <button class="btn btn-outline" onclick="closeUploadModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Contact Edit Modal -->
  <div id="contactModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
      <div style="padding: 1.25rem; border-bottom: 1px solid var(--gray-200);">
        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">Update Contact Info</h3>
      </div>
      <div style="padding: 1.5rem;">
        <input type="hidden" id="contactCVName">
        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); margin-bottom: 0.375rem;">Category</label>
          <input type="text" id="contactCategory" class="form-control" placeholder="e.g., Engineering">
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); margin-bottom: 0.375rem;">Department</label>
          <input type="text" id="contactDepartment" class="form-control" placeholder="e.g., IT">
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); margin-bottom: 0.375rem;">Email</label>
          <input type="email" id="contactEmail" class="form-control" placeholder="example@email.com">
        </div>
        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-size: 0.75rem; font-weight: 600; color: var(--gray-600); margin-bottom: 0.375rem;">Phone</label>
          <input type="tel" id="contactPhone" class="form-control" placeholder="0123456789">
        </div>
      </div>
      <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-200); display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button class="btn btn-outline" onclick="closeContactModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveContactInfo()">Save</button>
      </div>
    </div>
  </div>

  <!-- Analysis Modal -->
  <div id="analysisModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div style="padding: 1.25rem; border-bottom: 1px solid var(--gray-200);">
        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">
          CV Analysis: <span id="analysisCVName"></span>
        </h3>
      </div>
      <div style="padding: 1.5rem;">
        <div id="analysisLoading" class="text-center" style="padding: 2rem;">
          <div style="width: 2rem; height: 2rem; border: 3px solid var(--gray-200); border-top-color: var(--gray-900); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem;"></div>
          <p style="color: var(--gray-500);">Loading...</p>
        </div>
        <div id="analysisContent" class="hidden">
          <div class="analysis-stats">
            <div class="analysis-stat">
              <div class="analysis-stat-value" id="analysisBestScore">-</div>
              <div class="analysis-stat-label">Best Score</div>
            </div>
            <div class="analysis-stat">
              <div class="analysis-stat-value" id="analysisAvgScore">-</div>
              <div class="analysis-stat-label">Avg Score</div>
            </div>
            <div class="analysis-stat">
              <div class="analysis-stat-value" id="analysisTotalEvals">0</div>
              <div class="analysis-stat-label">Total Evals</div>
            </div>
          </div>
          <div id="analysisDetails"></div>
        </div>
      </div>
      <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-200); text-align: right;">
        <button class="btn btn-outline" onclick="closeAnalysisModal()">Close</button>
      </div>
    </div>
  </div>

  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    let allCVs = [];
    let filteredCVs = [];
    let currentPage = 1;
    let pageSize = 15;

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    function openUploadModal() {
      document.getElementById('uploadModal').classList.add('active');
    }

    function closeUploadModal() {
      document.getElementById('uploadModal').classList.remove('active');
    }

    function closeContactModal() {
      document.getElementById('contactModal').classList.remove('active');
    }

    function closeAnalysisModal() {
      document.getElementById('analysisModal').classList.remove('active');
    }

    function openContactModal(cvName, category, department, email, phone) {
      document.getElementById('contactModal').classList.add('active');
      document.getElementById('contactCVName').value = cvName;
      document.getElementById('contactCategory').value = category || '';
      document.getElementById('contactDepartment').value = department || '';
      document.getElementById('contactEmail').value = email || '';
      document.getElementById('contactPhone').value = phone || '';
    }

    async function saveContactInfo() {
      const cvName = document.getElementById('contactCVName').value;
      const category = document.getElementById('contactCategory').value.trim();
      const department = document.getElementById('contactDepartment').value.trim();
      const email = document.getElementById('contactEmail').value.trim();
      const phone = document.getElementById('contactPhone').value.trim();

      try {
        await updateCVMetadata(cvName, 'category', category);
        await updateCVMetadata(cvName, 'department', department);
        await updateCVMetadata(cvName, 'email', email);
        await updateCVMetadata(cvName, 'phone', phone);
        closeContactModal();
        loadCVs();
      } catch (e) {
        alert('Save failed: ' + e.message);
      }
    }

    async function updateCVMetadata(name, field, value) {
      await fetch(`/cvs/${encodeURIComponent(name)}/metadata`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ [field]: value })
      });
    }

    // Normalize Vietnamese text for search (remove diacritics)
    function normalizeVietnamese(str) {
      return str
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/đ/g, 'd')
        .replace(/Đ/g, 'D');
    }

    async function loadCVs() {
      try {
        const res = await fetch('/cvs?limit=1000');
        const data = await res.json();
        allCVs = data.items || [];
        applyFilters();
      } catch (e) {
        document.getElementById('tableBody').innerHTML = `
          <tr><td colspan="8" style="text-align: center; padding: 2rem; color: #dc2626;">Error loading data</td></tr>
        `;
      }
    }

    function applyFilters() {
      const search = document.getElementById('searchInput').value;
      const normalizedSearch = normalizeVietnamese(search);
      const status = document.getElementById('statusFilter').value;

      filteredCVs = allCVs.filter(cv => {
        if (normalizedSearch && !normalizeVietnamese(cv.name).includes(normalizedSearch)) return false;
        if (status === 'evaluated' && !cv.evaluation_count) return false;
        if (status === 'not_evaluated' && cv.evaluation_count) return false;
        return true;
      });

      currentPage = 1;
      renderTable();
    }

    function renderTable() {
      const start = (currentPage - 1) * pageSize;
      const pageItems = filteredCVs.slice(start, start + pageSize);
      const tbody = document.getElementById('tableBody');

      if (pageItems.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray-400);">No CVs found</td></tr>
        `;
        document.getElementById('pagination').classList.add('hidden');
        return;
      }

      tbody.innerHTML = pageItems.map(cv => {
        const hasEval = cv.evaluation_count > 0;
        const scoreClass = cv.best_score >= 8 ? 'high' : cv.best_score >= 6 ? 'medium' : 'low';
        const contactDisplay = cv.email || cv.phone ? 
          `${cv.email || ''}${cv.email && cv.phone ? '<br>' : ''}${cv.phone || ''}` : '-';
        
        return `
          <tr>
            <td><span class="cv-name">${cv.name}</span></td>
            <td>${cv.category ? `<span class="meta-tag">${cv.category}</span>` : '-'}</td>
            <td>${cv.department ? `<span class="meta-tag">${cv.department}</span>` : '-'}</td>
            <td style="font-size: 0.75rem; max-width: 150px;">${contactDisplay}</td>
            <td>
              <span class="status-badge ${hasEval ? 'evaluated' : 'not-evaluated'}">
                ${hasEval ? 'Evaluated' : 'Not Evaluated'}
              </span>
            </td>
            <td>${cv.evaluation_count || 0}</td>
            <td>
              ${hasEval ? `<span class="score-badge ${scoreClass}">${cv.best_score}/10</span>` : '-'}
            </td>
            <td style="text-align: right; white-space: nowrap;">
              <button class="action-btn" onclick="openContactModal('${cv.name}', '${cv.category || ''}', '${cv.department || ''}', '${cv.email || ''}', '${cv.phone || ''}')" title="Edit Info">
                <i class="bi bi-pencil"></i>
              </button>
              ${hasEval ? `<button class="action-btn" onclick="showAnalysis('${cv.name}')" title="Analysis"><i class="bi bi-graph-up"></i></button>` : ''}
              <button class="action-btn danger" onclick="deleteCV('${cv.name}')" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');

      renderPagination();
    }

    function renderPagination() {
      const total = filteredCVs.length;
      const pages = Math.ceil(total / pageSize);
      
      if (pages <= 1) {
        document.getElementById('pagination').classList.add('hidden');
        return;
      }

      const start = (currentPage - 1) * pageSize + 1;
      const end = Math.min(currentPage * pageSize, total);

      let pagesHTML = '';
      const maxButtons = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = Math.min(pages, startPage + maxButtons - 1);

      for (let i = startPage; i <= endPage; i++) {
        pagesHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      }

      document.getElementById('pagination').classList.remove('hidden');
      document.getElementById('pagination').innerHTML = `
        <div class="pagination-info">${start}-${end} of ${total}</div>
        <div class="pagination-nav">
          <button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="bi bi-chevron-left"></i>
          </button>
          ${pagesHTML}
          <button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === pages ? 'disabled' : ''}>
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      `;
    }

    function goToPage(page) {
      currentPage = page;
      renderTable();
    }

    async function showAnalysis(cvName) {
      document.getElementById('analysisModal').classList.add('active');
      document.getElementById('analysisCVName').textContent = cvName;
      document.getElementById('analysisLoading').classList.remove('hidden');
      document.getElementById('analysisContent').classList.add('hidden');

      try {
        const res = await fetch(`/cvs/${encodeURIComponent(cvName)}/evaluations`);
        const data = await res.json();

        document.getElementById('analysisBestScore').textContent = data.best_score || '-';
        document.getElementById('analysisAvgScore').textContent = data.average_score || '-';
        document.getElementById('analysisTotalEvals').textContent = data.total || 0;

        if (data.evaluations && data.evaluations.length > 0) {
          document.getElementById('analysisDetails').innerHTML = `
            <h4 style="font-size: 0.8125rem; font-weight: 600; margin-bottom: 0.75rem;">Evaluation History</h4>
            ${data.evaluations.map(e => `
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: var(--gray-50); border-radius: 4px; margin-bottom: 0.5rem;">
                <div style="flex: 1;">
                  <div style="font-weight: 500; font-size: 0.875rem;">${e.jd_name}</div>
                  <div style="font-size: 0.75rem; color: var(--gray-500);">${new Date(e.created_at).toLocaleDateString('vi-VN')}</div>
                </div>
                <div style="font-weight: 600; color: ${e.score >= 8 ? '#16a34a' : e.score >= 6 ? '#ca8a04' : '#dc2626'};">${e.score}/10</div>
                <a href="/report.html?id=${e.id}" class="action-btn" style="margin-left: 0.5rem;"><i class="bi bi-eye"></i></a>
              </div>
            `).join('')}
          `;
        } else {
          document.getElementById('analysisDetails').innerHTML = '<p style="color: var(--gray-500);">No evaluations yet</p>';
        }

        document.getElementById('analysisLoading').classList.add('hidden');
        document.getElementById('analysisContent').classList.remove('hidden');
      } catch (e) {
        document.getElementById('analysisLoading').innerHTML = '<p style="color: #dc2626;">Error loading data</p>';
      }
    }

    async function deleteCV(name) {
      if (!confirm(`Delete CV "${name}"?`)) return;
      try {
        await fetch(`/cvs/${encodeURIComponent(name)}`, { method: 'DELETE' });
        loadCVs();
      } catch (e) {
        alert('Delete failed');
      }
    }

    // Drag & Drop
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = 'var(--gray-900)';
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.style.borderColor = 'var(--gray-300)';
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = 'var(--gray-300)';
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    async function handleFiles(files) {
      for (const file of files) {
        const formData = new FormData();
        formData.append('file', file);
        try {
          await fetch('/cvs', { method: 'POST', body: formData });
        } catch (e) {}
      }
      closeUploadModal();
      loadCVs();
    }

    loadCVs();
  </script>
  <script src="/assets/js/settings.js?v=2"></script>
</body>
</html>
