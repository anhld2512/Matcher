<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report | Matcher</title>
  <link rel="stylesheet" href="/assets/css/shared.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* Report Layout */
    .report-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5rem;
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
    }

    .report-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .report-score {
      font-size: 2rem;
      font-weight: 700;
    }

    .report-score.high { color: #16a34a; }
    .report-score.medium { color: #ca8a04; }
    .report-score.low { color: #dc2626; }

    /* Metadata Grid */
    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      padding: 1.25rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .meta-item label {
      display: block;
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
      margin-bottom: 0.25rem;
    }

    .meta-item span {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-900);
    }

    /* Section */
    .report-section {
      padding: 1.25rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .report-section:last-child {
      border-bottom: none;
    }

    .section-title {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .section-content {
      font-size: 0.875rem;
      line-height: 1.7;
      color: var(--gray-700);
      white-space: pre-wrap;
    }

    /* Highlight Boxes */
    .highlight-box {
      padding: 1rem;
      border-radius: 6px;
      border-left: 3px solid;
    }

    .highlight-box.success {
      background: #f0fdf4;
      border-color: #16a34a;
    }

    .highlight-box.warning {
      background: #fffbeb;
      border-color: #ca8a04;
    }

    .highlight-box.info {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    /* Score Bar */
    .score-bar-container {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .score-bar-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .score-bar-label {
      width: 100px;
      font-size: 0.75rem;
      color: var(--gray-600);
    }

    .score-bar {
      flex: 1;
      height: 6px;
      background: var(--gray-200);
      border-radius: 3px;
      overflow: hidden;
    }

    .score-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .score-bar-value {
      width: 40px;
      text-align: right;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--gray-700);
    }

    /* Decision Grid */
    .decision-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 640px) {
      .decision-grid {
        grid-template-columns: 1fr;
      }
    }

    .decision-box {
      padding: 1rem;
      border-radius: 6px;
    }

    .decision-box.hire {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
    }

    .decision-box.concern {
      background: #fef2f2;
      border: 1px solid #fecaca;
    }

    .decision-box h4 {
      font-size: 0.75rem;
      font-weight: 600;
      margin: 0 0 0.75rem;
    }

    .decision-box.hire h4 { color: #16a34a; }
    .decision-box.concern h4 { color: #dc2626; }

    .decision-box ul {
      margin: 0;
      padding-left: 1.25rem;
      font-size: 0.8125rem;
      line-height: 1.6;
      color: var(--gray-700);
    }

    /* Loading */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-spinner {
      width: 2rem;
      height: 2rem;
      border: 3px solid var(--gray-200);
      border-top-color: var(--gray-900);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 3rem auto;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <i class="bi bi-diagram-3"></i>
          Matcher
        </a>
      </div>
      <nav class="sidebar-nav">
        <a href="/" class="nav-item">
          <i class="bi bi-bar-chart"></i>
          <span>Compare</span>
        </a>
        <a href="/jd-management.html" class="nav-item">
          <i class="bi bi-file-earmark-text"></i>
          <span>JD Management</span>
        </a>
        <a href="/cv-management.html" class="nav-item">
          <i class="bi bi-person-badge"></i>
          <span>CV Management</span>
        </a>
        <a href="/history.html" class="nav-item active">
          <i class="bi bi-clock-history"></i>
          <span>History</span>
        </a>
        <div style="flex: 1;"></div>
        <a href="#" class="nav-item" onclick="openAiSettingsModal()">
          <i class="bi bi-gear"></i>
          <span>AI Settings</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <header class="header">
        <button class="mobile-menu-toggle" onclick="toggleSidebar()">
          <i class="bi bi-list"></i>
        </button>
        <h1 class="header-title">Evaluation Report</h1>
        <div class="header-toolbar">
          <a href="/history.html" class="btn btn-outline">
            <i class="bi bi-arrow-left"></i>
            Back
          </a>
        </div>
      </header>

      <!-- Content -->
      <main class="content">
        <!-- Loading -->
        <div id="loadingCard" class="card">
          <div class="loading-spinner"></div>
          <p style="text-align: center; color: var(--gray-500);">Loading report...</p>
        </div>

        <!-- Report -->
        <div id="reportCard" class="card hidden">
          <div class="report-header">
            <div>
              <div class="report-title" id="reportTitle"></div>
            </div>
            <div class="report-score" id="reportScore"></div>
          </div>

          <!-- Metadata -->
          <div class="meta-grid">
            <div class="meta-item">
              <label>CV</label>
              <span id="cvName"></span>
            </div>
            <div class="meta-item">
              <label>JD</label>
              <span id="jdName"></span>
            </div>
            <div class="meta-item">
              <label>Date</label>
              <span id="generatedAt"></span>
            </div>
            <div class="meta-item">
              <label>Recommendation</label>
              <span id="recommendation"></span>
            </div>
          </div>

          <!-- Summary -->
          <div class="report-section">
            <div class="section-title">Summary</div>
            <div id="executiveSummary" class="section-content"></div>
          </div>

          <!-- Score Breakdown -->
          <div class="report-section">
            <div class="section-title">Score Breakdown</div>
            <div id="scoreBreakdown" class="score-bar-container"></div>
          </div>

          <!-- Strengths -->
          <div class="report-section">
            <div class="section-title">
              <i class="bi bi-check-circle" style="color: #16a34a;"></i>
              Strengths
            </div>
            <div id="strengths" class="highlight-box success section-content"></div>
          </div>

          <!-- Weaknesses -->
          <div class="report-section">
            <div class="section-title">
              <i class="bi bi-exclamation-triangle" style="color: #ca8a04;"></i>
              Areas for Improvement
            </div>
            <div id="weaknesses" class="highlight-box warning section-content"></div>
          </div>

          <!-- Justification -->
          <div class="report-section">
            <div class="section-title">Detailed Analysis</div>
            <div id="justification" class="highlight-box info section-content"></div>
          </div>

          <!-- Decision Support -->
          <div class="report-section">
            <div class="section-title">Decision Support</div>
            <div class="decision-grid">
              <div class="decision-box hire">
                <h4><i class="bi bi-check-circle"></i> Reasons to Hire</h4>
                <ul id="hiringReasons"></ul>
              </div>
              <div class="decision-box concern">
                <h4><i class="bi bi-x-circle"></i> Concerns</h4>
                <ul id="concerns"></ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Error -->
        <div id="errorCard" class="card hidden" style="text-align: center; padding: 3rem;">
          <i class="bi bi-exclamation-triangle" style="font-size: 2rem; color: #dc2626;"></i>
          <p style="font-weight: 600; margin-top: 1rem;">Report not found</p>
          <a href="/history.html" class="btn btn-outline" style="margin-top: 1rem;">
            <i class="bi bi-arrow-left"></i> Back to History
          </a>
        </div>
      </main>
    </div>
  </div>

  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    async function loadReport() {
      const params = new URLSearchParams(window.location.search);
      const evaluationId = params.get('id');

      if (!evaluationId) {
        showError();
        return;
      }

      try {
        const res = await fetch(`/evaluations/${evaluationId}`);
        if (!res.ok) {
          showError();
          return;
        }
        const data = await res.json();
        if (!data.details) {
          showError();
          return;
        }
        displayReport(data);
      } catch (e) {
        showError();
      }
    }

    function displayReport(data) {
      document.getElementById('loadingCard').classList.add('hidden');
      document.getElementById('reportCard').classList.remove('hidden');

      // Handle both regular and quick evaluations
      const details = data.details || {};
      const isQuickEval = details.type === 'quick_evaluation';
      
      // Get score from either location
      const score = data.score || details.score || 0;
      const scoreClass = score >= 8 ? 'high' : score >= 6 ? 'medium' : 'low';

      // Get recommendation
      let recommendation = details.recommendation || 'N/A';
      
      // Map recommendations to colors
      const recColorMap = {
        'RECOMMEND': '#16a34a', 'HIRE': '#16a34a', 'EXCELLENT': '#16a34a', 'GOOD': '#16a34a',
        'CONSIDER': '#ca8a04', 'AVERAGE': '#ca8a04',
        'REJECT': '#dc2626', 'BELOW_AVERAGE': '#dc2626'
      };

      document.getElementById('reportTitle').textContent = data.cv_name || 'N/A';
      const scoreEl = document.getElementById('reportScore');
      scoreEl.textContent = `${score}/10`;
      scoreEl.className = `report-score ${scoreClass}`;

      document.getElementById('cvName').textContent = data.cv_name || 'N/A';
      document.getElementById('jdName').textContent = data.jd_name || 'N/A';
      document.getElementById('generatedAt').textContent = data.created_at ? new Date(data.created_at).toLocaleString('vi-VN') : 'N/A';

      const recEl = document.getElementById('recommendation');
      recEl.textContent = recommendation;
      recEl.style.color = recColorMap[recommendation] || '#6b7280';

      // Summary - use actual summary for quick evals
      if (isQuickEval && details.summary) {
        document.getElementById('executiveSummary').textContent = details.summary;
      } else {
        document.getElementById('executiveSummary').textContent = 
          `Score: ${score}/10. Recommendation: ${recommendation}. ` +
          (score >= 8 ? 'Strong candidate, well-suited for the position.' :
           score >= 6 ? 'Good potential, requires further evaluation.' :
           'Does not meet requirements for this role.');
      }

      // Score Breakdown - estimate from overall score
      const categories = [
        { name: 'Technical', score: score >= 7 ? Math.min(score + 1, 10) : score >= 5 ? score : Math.max(score - 1, 0), color: '#3b82f6' },
        { name: 'Experience', score: score >= 7 ? score : score >= 5 ? Math.max(score - 1, 0) : Math.max(score - 2, 0), color: '#8b5cf6' },
        { name: 'Culture Fit', score: score >= 7 ? Math.min(score + 1, 10) : score, color: '#10b981' }
      ];
      
      document.getElementById('scoreBreakdown').innerHTML = categories.map(cat => `
        <div class="score-bar-item">
          <div class="score-bar-label">${cat.name}</div>
          <div class="score-bar">
            <div class="score-bar-fill" style="width: ${cat.score * 10}%; background: ${cat.color};"></div>
          </div>
          <div class="score-bar-value">${cat.score}/10</div>
        </div>
      `).join('');

      document.getElementById('strengths').textContent = details.strengths || 'No data';
      document.getElementById('weaknesses').textContent = details.weaknesses || 'No data';
      
      // Justification - show salary estimate for quick evals
      if (isQuickEval && details.salary_estimate) {
        document.getElementById('justification').textContent = `Salary Estimate: ${details.salary_estimate}`;
      } else {
        document.getElementById('justification').textContent = details.justification || 'No data';
      }

      // Decision Support
      const hiringReasons = [];
      const concerns = [];

      if (details.strengths && details.strengths !== 'N/A') {
        details.strengths.split('\n').filter(s => s.trim()).slice(0, 3).forEach(s => {
          hiringReasons.push(s.replace(/^[-•*]\s*/, ''));
        });
      }
      if (score >= 8) hiringReasons.push('High evaluation score');
      if (isQuickEval && details.salary_estimate) hiringReasons.push(`Salary: ${details.salary_estimate}`);
      if (hiringReasons.length === 0) hiringReasons.push('Shows potential for growth');

      if (details.weaknesses && details.weaknesses !== 'N/A') {
        details.weaknesses.split('\n').filter(s => s.trim()).slice(0, 3).forEach(s => {
          concerns.push(s.replace(/^[-•*]\s*/, ''));
        });
      }
      if (score < 6) concerns.push('Below expected requirements');
      if (concerns.length === 0) concerns.push('No major concerns identified');

      document.getElementById('hiringReasons').innerHTML = hiringReasons.map(r => `<li>${r}</li>`).join('');
      document.getElementById('concerns').innerHTML = concerns.map(c => `<li>${c}</li>`).join('');
    }

    function showError() {
      document.getElementById('loadingCard').classList.add('hidden');
      document.getElementById('errorCard').classList.remove('hidden');
    }

    loadReport();
  </script>
  <script src="/assets/js/settings.js?v=2"></script>
</body>
</html>
