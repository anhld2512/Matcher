<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evaluation Details | Matcher</title>
  <link rel="stylesheet" href="/assets/css/shared.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <i class="bi bi-diagram-3"></i>
          Matcher
        </a>
      </div>
      <nav class="sidebar-nav">
        <a href="/" class="nav-item">
          <i class="bi bi-bar-chart"></i>
          <span>Compare</span>
        </a>
        <a href="/jd-management.html" class="nav-item">
          <i class="bi bi-file-earmark-text"></i>
          <span>JD Management</span>
        </a>
        <a href="/cv-management.html" class="nav-item">
          <i class="bi bi-person-badge"></i>
          <span>CV Management</span>
        </a>
        <a href="/history.html" class="nav-item active">
          <i class="bi bi-clock-history"></i>
          <span>History</span>
        </a>
        <div style="flex: 1;"></div>
        <a href="#" class="nav-item" onclick="openAiSettingsModal()">
          <i class="bi bi-gear"></i>
          <span>AI Settings</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <header class="header">
        <button class="mobile-menu-toggle" onclick="toggleSidebar()">
          <i class="bi bi-list"></i>
        </button>
        <h1 class="header-title">Evaluation Details</h1>
        <div class="header-toolbar">
          <a href="/history.html" class="btn btn-outline">
            <i class="bi bi-arrow-left"></i>
            <span>Back</span>
          </a>
        </div>
      </header>

      <!-- Content -->
      <main class="content">
        <div id="loadingCard" class="card">
          <div class="card-body text-center">
            <div style="width: 3rem; height: 3rem; border: 4px solid var(--primary-color); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 2rem auto;"></div>
            <p style="color: var(--gray-600);">Loading data...</p>
          </div>
        </div>

        <div id="reportCard" class="card hidden">
          <div class="card-header" style="background: linear-gradient(to right, var(--primary-color), var(--primary-dark));">
            <div style="display: flex; align-items: center; justify-content: space-between; color: white;">
              <h2 style="margin: 0; font-size: 1.25rem;">
                <i class="bi bi-file-earmark-text"></i>
                <span id="reportTitle">Evaluation Report</span>
              </h2>
              <span id="reportScore" style="font-size: 2rem; font-weight: 700;"></span>
            </div>
          </div>
          <div class="card-body">
            <!-- Metadata -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; padding: 1rem; background: var(--gray-50); border-radius: 0.5rem;">
              <div>
                <p style="font-size: 0.75rem; color: var(--gray-600); margin: 0;">CV</p>
                <p style="font-weight: 600; color: var(--gray-800); margin: 0.25rem 0 0;" id="cvName"></p>
              </div>
              <div>
                <p style="font-size: 0.75rem; color: var(--gray-600); margin: 0;">JD</p>
                <p style="font-weight: 600; color: var(--gray-800); margin: 0.25rem 0 0;" id="jdName"></p>
              </div>
              <div>
                <p style="font-size: 0.75rem; color: var(--gray-600); margin: 0;">Date</p>
                <p style="font-weight: 600; color: var(--gray-800); margin: 0.25rem 0 0;" id="generatedAt"></p>
              </div>
              <div>
                <p style="font-size: 0.75rem; color: var(--gray-600); margin: 0;">Recommendation</p>
                <p style="font-weight: 600; margin: 0.25rem 0 0;" id="recommendation"></p>
              </div>
            </div>

            <!-- Executive Summary -->
            <div class="mb-4">
              <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="bi bi-stars" style="color: var(--primary-color);"></i>
                Executive Summary
              </h3>
              <div style="padding: 1.5rem; background: linear-gradient(135deg, #667eea15, #764ba215); border-radius: 0.5rem; border: 1px solid var(--primary-color);">
                <div id="executiveSummary" style="font-size: 1rem; line-height: 1.8; color: var(--gray-700);"></div>
              </div>
            </div>

            <!-- Score Visualization -->
            <div class="mb-4">
              <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="bi bi-speedometer2" style="color: var(--primary-color);"></i>
                Score Analysis
              </h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <div style="text-align: center; padding: 1.5rem; background: white; border: 2px solid var(--gray-200); border-radius: 0.5rem;">
                  <div style="position: relative; width: 120px; height: 120px; margin: 0 auto 1rem;">
                    <svg width="120" height="120" style="transform: rotate(-90deg);">
                      <circle cx="60" cy="60" r="50" fill="none" stroke="var(--gray-200)" stroke-width="10"></circle>
                      <circle id="scoreCircle" cx="60" cy="60" r="50" fill="none" stroke="var(--primary-color)" stroke-width="10"
                              stroke-dasharray="314" stroke-dashoffset="314" stroke-linecap="round"
                              style="transition: stroke-dashoffset 1s ease;"></circle>
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; font-weight: 700;" id="scoreGauge"></div>
                  </div>
                  <p style="font-weight: 600; color: var(--gray-700); margin: 0;">Overall Score</p>
                  <p id="scoreInterpretation" style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.5rem;"></p>
                </div>

                <div style="padding: 1.5rem; background: white; border: 2px solid var(--gray-200); border-radius: 0.5rem;">
                  <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-700); margin: 0 0 1rem;">Detailed Assessment</h4>
                  <div id="scoreBreakdown" style="display: flex; flex-direction: column; gap: 1rem;"></div>
                </div>
              </div>
            </div>

            <!-- Strengths -->
            <div class="mb-4">
              <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--success-color); margin-bottom: 0.75rem;">
                <i class="bi bi-check-circle-fill"></i>
                Strengths
              </h3>
              <div id="strengths" style="padding: 1rem; background: var(--success-light); border-left: 4px solid var(--success-color); border-radius: 0.5rem; white-space: pre-wrap; line-height: 1.6;"></div>
            </div>

            <!-- Weaknesses -->
            <div class="mb-4">
              <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--warning-color); margin-bottom: 0.75rem;">
                <i class="bi bi-exclamation-triangle-fill"></i>
                Weaknesses
              </h3>
              <div id="weaknesses" style="padding: 1rem; background: var(--warning-light); border-left: 4px solid var(--warning-color); border-radius: 0.5rem; white-space: pre-wrap; line-height: 1.6;"></div>
            </div>

            <!-- Justification -->
            <div class="mb-4">
              <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--primary-color); margin-bottom: 0.75rem;">
                <i class="bi bi-chat-left-text-fill"></i>
                Detailed Justification
              </h3>
              <div id="justification" style="padding: 1rem; background: var(--gray-50); border-left: 4px solid var(--primary-color); border-radius: 0.5rem; white-space: pre-wrap; line-height: 1.6;"></div>
            </div>

            <!-- Interview Recommendations -->
            <div class="mb-4">
              <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="bi bi-chat-quote" style="color: #8b5cf6;"></i>
                Interview Recommendations
              </h3>
              <div style="padding: 1.5rem; background: #8b5cf615; border-left: 4px solid #8b5cf6; border-radius: 0.5rem;">
                <div id="interviewRecommendations"></div>
              </div>
            </div>



            <!-- Risk Assessment -->
            <div class="mb-4">
              <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="bi bi-shield-exclamation" style="color: #f59e0b;"></i>
                Risk Assessment
              </h3>
              <div style="padding: 1.5rem; background: #f59e0b15; border-left: 4px solid #f59e0b; border-radius: 0.5rem;">
                <div id="riskAssessment"></div>
              </div>
            </div>

            <!-- Decision Support -->
            <div class="mb-4">
              <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-800); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="bi bi-lightbulb" style="color: #10b981;"></i>
                Decision Support
              </h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                <div style="padding: 1.5rem; background: #10b98115; border-radius: 0.5rem; border: 1px solid #10b981;">
                  <h4 style="font-size: 1rem; font-weight: 600; color: #10b981; margin: 0 0 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="bi bi-check-circle-fill"></i>
                    Reasons to Hire
                  </h4>
                  <ul id="hiringReasons" style="margin: 0; padding-left: 1.25rem; line-height: 1.8;"></ul>
                </div>
                <div style="padding: 1.5rem; background: #ef444415; border-radius: 0.5rem; border: 1px solid #ef4444;">
                  <h4 style="font-size: 1rem; font-weight: 600; color: #ef4444; margin: 0 0 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="bi bi-x-circle-fill"></i>
                    Points of Concern
                  </h4>
                  <ul id="concerns" style="margin: 0; padding-left: 1.25rem; line-height: 1.8;"></ul>
                </div>
              </div>
            </div>


          </div>
        </div>

        <div id="errorCard" class="card hidden">
          <div class="card-body text-center">
            <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: var(--danger-color);"></i>
            <p style="font-size: 1.125rem; font-weight: 600; color: var(--gray-800); margin-top: 1rem;">Report not found</p>
            <p style="color: var(--gray-600);">Invalid evaluation ID or the report has been deleted.</p>
            <a href="/history.html" class="btn btn-primary" style="margin-top: 1rem;">
              <i class="bi bi-arrow-left"></i>
              Back to history
            </a>
          </div>
        </div>
      </main>
    </div>
  </div>

  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    async function loadReport() {
      const params = new URLSearchParams(window.location.search);
      const evaluationId = params.get('id');

      if (!evaluationId) {
        showError('Evaluation ID not found in URL');
        return;
      }

      try {
        const res = await fetch(`/evaluations/${evaluationId}`);

        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          showError(`Loading error: ${errorData.detail || 'Evaluation not found'}`);
          return;
        }

        const data = await res.json();

        if (!data.details) {
          showError('Incomplete evaluation data');
          return;
        }

        displayReport(data);
      } catch (e) {
        console.error('Error loading report:', e);
        showError('Connection error: ' + e.message);
      }
    }

    function translateRecommendation(rec) {
      const translations = {
        'HIRE': 'Hire',
        'RECOMMEND': 'Recommend',
        'CONSIDER': 'Consider',
        'REJECT': 'Reject'
      };
      return translations[rec] || rec;
    }

    function displayReport(data) {
      document.getElementById('loadingCard').classList.add('hidden');
      document.getElementById('reportCard').classList.remove('hidden');

      const details = data.details;

      // Title and Score
      document.getElementById('reportTitle').textContent = `Evaluation: ${details.cv_name}`;
      const scoreColor = details.score >= 8 ? 'success' : details.score >= 6 ? 'warning' : 'danger';
      const scoreEl = document.getElementById('reportScore');
      scoreEl.textContent = `${details.score}/10`;
      scoreEl.style.color = `var(--${scoreColor}-color)`;

      // Metadata
      document.getElementById('cvName').textContent = details.cv_name;
      document.getElementById('jdName').textContent = details.jd_name;
      document.getElementById('generatedAt').textContent = details.generated_at || 'N/A';

      const recEl = document.getElementById('recommendation');
      recEl.textContent = translateRecommendation(details.recommendation);
      const recColor = (details.recommendation === 'HIRE' || details.recommendation === 'RECOMMEND') ? 'success' :
                       details.recommendation === 'CONSIDER' ? 'warning' : 'danger';
      recEl.style.color = `var(--${recColor}-color)`;

      // Executive Summary
      const summary = generateExecutiveSummary(details);
      document.getElementById('executiveSummary').innerHTML = summary;

      // Score Visualization
      const scorePercentage = (details.score / 10) * 100;
      const circumference = 314; // 2 * PI * 50
      const offset = circumference - (circumference * scorePercentage / 100);
      const scoreCircle = document.getElementById('scoreCircle');
      scoreCircle.style.strokeDashoffset = offset;
      scoreCircle.style.stroke = `var(--${scoreColor}-color)`;

      document.getElementById('scoreGauge').textContent = details.score;
      document.getElementById('scoreGauge').style.color = `var(--${scoreColor}-color)`;

      const interpretation = getScoreInterpretation(details.score);
      document.getElementById('scoreInterpretation').textContent = interpretation;

      // Score Breakdown
      const breakdown = generateScoreBreakdown(details);
      document.getElementById('scoreBreakdown').innerHTML = breakdown;

      // Content
      document.getElementById('strengths').textContent = details.strengths || 'N/A';
      document.getElementById('weaknesses').textContent = details.weaknesses || 'N/A';
      document.getElementById('justification').textContent = details.justification || 'N/A';

      // Interview Recommendations
      const interviewRecs = generateInterviewRecommendations(details);
      document.getElementById('interviewRecommendations').innerHTML = interviewRecs;



      // Risk Assessment
      const risks = generateRiskAssessment(details);
      document.getElementById('riskAssessment').innerHTML = risks;

      // Decision Support
      const { hiringReasons, concerns } = generateDecisionSupport(details);
      document.getElementById('hiringReasons').innerHTML = hiringReasons;
      document.getElementById('concerns').innerHTML = concerns;


    }

    function generateExecutiveSummary(details) {
      const scoreLevel = details.score >= 8 ? 'excellent' : details.score >= 6 ? 'good' : details.score >= 4 ? 'average' : 'poor';
      const recText = translateRecommendation(details.recommendation).toLowerCase();

      return `
        <p style="margin: 0 0 1rem;"><strong>Candidate ${details.cv_name}</strong> scored <strong style="color: var(--${details.score >= 8 ? 'success' : details.score >= 6 ? 'warning' : 'danger'}-color);">${details.score}/10</strong> (${scoreLevel} level) when compared to position <strong>${details.jd_name}</strong>.</p>
        <p style="margin: 0;"><strong>Recommendation:</strong> <span style="color: var(--${(details.recommendation === 'HIRE' || details.recommendation === 'RECOMMEND') ? 'success' : details.recommendation === 'CONSIDER' ? 'warning' : 'danger'}-color); font-weight: 600; text-transform: uppercase;">${recText}</span>. ${getRecommendationExplanation(details)}</p>
      `;
    }

    function getRecommendationExplanation(details) {
      if (details.recommendation === 'HIRE' || details.recommendation === 'RECOMMEND') {
        return 'The candidate is well-qualified and should proceed to the next recruitment stages.';
      } else if (details.recommendation === 'CONSIDER') {
        return 'The candidate shows potential but needs closer evaluation in interviews to confirm capabilities.';
      } else {
        return 'The candidate does not meet the requirements for this position. Consider other candidates.';
      }
    }

    function getScoreInterpretation(score) {
      if (score >= 9) return 'Excellent fit';
      if (score >= 8) return 'Strong fit';
      if (score >= 7) return 'Good fit';
      if (score >= 6) return 'Moderate fit';
      if (score >= 5) return 'Needs consideration';
      if (score >= 4) return 'Weak fit';
      return 'Poor fit';
    }

    function generateScoreBreakdown(details) {
      const categories = [
        { name: 'Technical Skills', score: details.score >= 7 ? 9 : details.score >= 5 ? 7 : 5, color: '#3b82f6' },
        { name: 'Work Experience', score: details.score >= 7 ? 8 : details.score >= 5 ? 6 : 4, color: '#8b5cf6' },
        { name: 'Cultural Fit', score: details.score >= 7 ? 8 : details.score >= 5 ? 6 : 5, color: '#10b981' }
      ];

      return categories.map(cat => `
        <div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="font-size: 0.875rem; color: var(--gray-700);">${cat.name}</span>
            <span style="font-size: 0.875rem; font-weight: 600; color: ${cat.color};">${cat.score}/10</span>
          </div>
          <div style="height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
            <div style="height: 100%; width: ${cat.score * 10}%; background: ${cat.color}; transition: width 1s ease;"></div>
          </div>
        </div>
      `).join('');
    }

    function generateInterviewRecommendations(details) {
      const questions = [];

      if (details.weaknesses && details.weaknesses !== 'N/A') {
        questions.push('Clarify missing skills or experience mentioned in the weaknesses section');
        questions.push('Ask about specific projects related to job requirements');
      }

      questions.push('Assess ability to learn and adapt to new technologies');
      questions.push('Understand candidate\'s motivation and career development plans');

      if (details.score < 7) {
        questions.push('Thoroughly verify practical experience through specific scenarios');
      }

      return `
        <h4 style="font-size: 1rem; font-weight: 600; margin: 0 0 1rem; color: var(--gray-700);">Key Questions to Focus On:</h4>
        <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
          ${questions.map(q => `<li>${q}</li>`).join('')}
        </ul>
        <p style="margin: 1rem 0 0; padding: 1rem; background: white; border-radius: 0.25rem; font-size: 0.875rem; color: var(--gray-600);">
          <i class="bi bi-info-circle"></i> Note: Focus on verifying the identified strengths and clarifying the weaknesses found in the evaluation.
        </p>
      `;
    }



    function generateRiskAssessment(details) {
      const risks = [];

      if (details.score < 6) {
        risks.push({ level: 'High', risk: 'Capabilities do not meet requirements', mitigation: 'Reconsider or provide intensive training program' });
      } else if (details.score < 7) {
        risks.push({ level: 'Medium', risk: 'Requires onboarding time and additional training', mitigation: 'Plan detailed onboarding with mentor support' });
      }

      if (details.weaknesses && details.weaknesses !== 'N/A' && details.weaknesses.length > 100) {
        risks.push({ level: 'Medium', risk: 'Multiple weaknesses need improvement', mitigation: 'Careful evaluation during probation period' });
      }

      if (risks.length === 0) {
        return `
          <div style="padding: 1rem; background: #10b98115; border-radius: 0.25rem; border: 1px solid #10b981;">
            <p style="margin: 0; color: #10b981; font-weight: 600;">
              <i class="bi bi-check-circle-fill"></i> Low risk
            </p>
            <p style="margin: 0.5rem 0 0; font-size: 0.875rem; color: var(--gray-600);">Candidate fits well with requirements. Hiring risk is at acceptable level.</p>
          </div>
        `;
      }

      return `
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          ${risks.map(risk => `
            <div style="padding: 1rem; background: white; border-radius: 0.25rem; border-left: 3px solid ${risk.level === 'High' ? '#ef4444' : '#f59e0b'};">
              <div style="margin-bottom: 0.5rem;">
                <span style="padding: 0.25rem 0.75rem; background: ${risk.level === 'High' ? '#ef444420' : '#f59e0b20'}; color: ${risk.level === 'High' ? '#ef4444' : '#f59e0b'}; border-radius: 1rem; font-size: 0.75rem; font-weight: 600;">
                  ${risk.level} Risk
                </span>
              </div>
              <p style="margin: 0.5rem 0; font-weight: 600; color: var(--gray-800);">${risk.risk}</p>
              <p style="margin: 0; font-size: 0.875rem; color: var(--gray-600);"><strong>Mitigation:</strong> ${risk.mitigation}</p>
            </div>
          `).join('')}
        </div>
      `;
    }

    function generateDecisionSupport(details) {
      const hiringReasons = [];
      const concerns = [];

      // Hiring reasons based on strengths and score
      if (details.strengths && details.strengths !== 'N/A') {
        const strengthPoints = details.strengths.split('\n').filter(s => s.trim()).slice(0, 3);
        strengthPoints.forEach(point => hiringReasons.push(point.replace(/^[-•*]\s*/, '')));
      }

      if (details.score >= 8) {
        hiringReasons.push('High evaluation score, good fit with requirements');
      }

      if (hiringReasons.length === 0) {
        hiringReasons.push('Has development potential');
      }

      // Concerns based on weaknesses and score
      if (details.weaknesses && details.weaknesses !== 'N/A') {
        const weaknessPoints = details.weaknesses.split('\n').filter(w => w.trim()).slice(0, 3);
        weaknessPoints.forEach(point => concerns.push(point.replace(/^[-•*]\s*/, '')));
      }

      if (details.score < 6) {
        concerns.push('Low evaluation score, requires careful consideration');
      }

      if (concerns.length === 0) {
        concerns.push('No significant concerns identified');
      }

      return {
        hiringReasons: hiringReasons.map(r => `<li>${r}</li>`).join(''),
        concerns: concerns.map(c => `<li>${c}</li>`).join('')
      };
    }



    function showError(message = 'Report not found') {
      document.getElementById('loadingCard').classList.add('hidden');
      const errorCard = document.getElementById('errorCard');
      errorCard.classList.remove('hidden');
      // Update error message if provided
      const errorMsg = errorCard.querySelector('p:last-of-type');
      if (errorMsg && message) {
        errorMsg.textContent = message;
      }
    }

    loadReport();
  </script>

  <script src="/assets/js/settings.js?v=2"></script>
</body>
</html>
