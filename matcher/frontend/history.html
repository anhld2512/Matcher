<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>History | Matcher</title>
  <link rel="stylesheet" href="/assets/css/shared.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* Clean Filter Bar */
    .filter-bar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-bar input,
    .filter-bar select {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 0.8125rem;
      background: white;
    }

    .filter-bar input:focus,
    .filter-bar select:focus {
      outline: none;
      border-color: var(--gray-900);
    }

    .filter-bar input {
      flex: 1;
      min-width: 200px;
    }

    /* Evaluation List */
    .eval-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .eval-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      transition: border-color 0.15s;
    }

    .eval-item:hover {
      border-color: var(--gray-400);
    }

    .eval-score {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-size: 1.25rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .eval-score.high { background: #dcfce7; color: #16a34a; }
    .eval-score.medium { background: #fef3c7; color: #ca8a04; }
    .eval-score.low { background: #fee2e2; color: #dc2626; }

    .eval-info {
      flex: 1;
      min-width: 0;
    }

    .eval-cv {
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 0.25rem;
    }

    .eval-jd {
      font-size: 0.8125rem;
      color: var(--gray-600);
    }

    .eval-meta {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    .eval-tag {
      padding: 0.125rem 0.5rem;
      background: var(--gray-100);
      border-radius: 4px;
      font-size: 0.6875rem;
      color: var(--gray-600);
    }

    .eval-actions {
      flex-shrink: 0;
    }

    .eval-actions a {
      padding: 0.5rem 1rem;
      background: var(--gray-100);
      border-radius: 6px;
      color: var(--gray-700);
      font-size: 0.8125rem;
      text-decoration: none;
      transition: background 0.15s;
    }

    .eval-actions a:hover {
      background: var(--gray-200);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 1rem;
      color: var(--gray-400);
    }

    .empty-state i {
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }

    /* Pagination */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
      border-radius: 0 0 6px 6px;
    }

    .pagination-info {
      font-size: 0.8125rem;
      color: var(--gray-600);
    }

    .pagination-nav {
      display: flex;
      gap: 0.25rem;
    }

    .pagination-btn {
      min-width: 2rem;
      height: 2rem;
      padding: 0 0.5rem;
      border: 1px solid var(--gray-300);
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8125rem;
      color: var(--gray-700);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .pagination-btn:hover:not(:disabled) {
      background: var(--gray-100);
    }

    .pagination-btn.active {
      background: var(--gray-900);
      color: white;
      border-color: var(--gray-900);
    }

    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Group Header */
    .group-header {
      padding: 0.75rem 1rem;
      background: var(--gray-100);
      border-radius: 6px;
      margin: 1.5rem 0 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .group-header:first-child {
      margin-top: 0;
    }

    .group-title {
      font-weight: 600;
      color: var(--gray-900);
    }

    .group-count {
      font-size: 0.75rem;
      color: var(--gray-600);
    }

    /* Stats Modal */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .stat-card {
      padding: 1.5rem;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--gray-900);
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--gray-600);
      margin-top: 0.25rem;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <i class="bi bi-diagram-3"></i>
          Matcher
        </a>
      </div>
      <nav class="sidebar-nav">
        <a href="/" class="nav-item">
          <i class="bi bi-bar-chart"></i>
          <span>Compare</span>
        </a>
        <a href="/jd-management.html" class="nav-item">
          <i class="bi bi-file-earmark-text"></i>
          <span>JD Management</span>
        </a>
        <a href="/cv-management.html" class="nav-item">
          <i class="bi bi-person-badge"></i>
          <span>CV Management</span>
        </a>
        <a href="/history.html" class="nav-item active">
          <i class="bi bi-clock-history"></i>
          <span>History</span>
        </a>
        <div style="flex: 1;"></div>
        <a href="#" class="nav-item" onclick="openAiSettingsModal()">
          <i class="bi bi-gear"></i>
          <span>AI Settings</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <header class="header">
        <button class="mobile-menu-toggle" onclick="toggleSidebar()">
          <i class="bi bi-list"></i>
        </button>
        <h1 class="header-title">History</h1>
        <div class="header-toolbar">
          <button class="btn btn-outline" onclick="openStatsModal()">
            <i class="bi bi-bar-chart"></i>
          </button>
          <button class="btn btn-outline" onclick="loadHistory()">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </header>

      <!-- Content -->
      <main class="content">
        <!-- Filters -->
        <div class="filter-bar" style="margin-bottom: 1.5rem;">
          <input type="text" id="searchAll" placeholder="Search CV or JD..." oninput="applyFilters()">
          <select id="scoreFilter" onchange="applyFilters()">
            <option value="">All Scores</option>
            <option value="8-10">8-10 (Excellent)</option>
            <option value="6-8">6-8 (Good)</option>
            <option value="0-6">0-6 (Below)</option>
          </select>
          <select id="groupBy" onchange="applyFilters()">
            <option value="">No Grouping</option>
            <option value="jd">By JD</option>
            <option value="cv">By CV</option>
            <option value="date">By Date</option>
          </select>
        </div>

        <!-- Results -->
        <div class="card">
          <div id="resultsContainer" style="padding: 0.5rem;">
            <div class="empty-state">
              <i class="bi bi-hourglass"></i>
              <p>Loading...</p>
            </div>
          </div>
          <div id="paginationContainer" class="pagination hidden"></div>
        </div>
      </main>
    </div>
  </div>

  <!-- Stats Modal -->
  <div id="statsModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div style="padding: 1.25rem; border-bottom: 1px solid var(--gray-200);">
        <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">Statistics</h3>
      </div>
      <div style="padding: 1.5rem;">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalEvalsModal">-</div>
            <div class="stat-label">Total Evaluations</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgScoreModal">-</div>
            <div class="stat-label">Avg Score</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="excellentCountModal">-</div>
            <div class="stat-label">Excellent (≥8)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="todayCountModal">-</div>
            <div class="stat-label">Today</div>
          </div>
        </div>
      </div>
      <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-200); text-align: right;">
        <button class="btn btn-outline" onclick="closeStatsModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    let allEvaluations = [];
    let filteredEvaluations = [];
    let statsData = null;
    let currentPage = 1;
    let pageSize = 20;

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    function openStatsModal() {
      document.getElementById('statsModal').classList.add('active');
      if (statsData) {
        document.getElementById('totalEvalsModal').textContent = statsData.total_evaluations;
        document.getElementById('avgScoreModal').textContent = statsData.avg_score;
        document.getElementById('excellentCountModal').textContent = statsData.excellent_count;
        document.getElementById('todayCountModal').textContent = statsData.today_count;
      }
    }

    function closeStatsModal() {
      document.getElementById('statsModal').classList.remove('active');
    }

    // Normalize Vietnamese text for search (remove diacritics)
    function normalizeVietnamese(str) {
      return str
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/đ/g, 'd')
        .replace(/Đ/g, 'D');
    }

    async function loadHistory() {
      try {
        const res = await fetch('/evaluations');
        const data = await res.json();
        allEvaluations = data.items || [];
        statsData = data.stats;
        applyFilters();
      } catch (e) {
        document.getElementById('resultsContainer').innerHTML = `
          <div class="empty-state">
            <i class="bi bi-exclamation-triangle"></i>
            <p>Error loading data</p>
          </div>
        `;
      }
    }

    function applyFilters() {
      const search = document.getElementById('searchAll').value;
      const normalizedSearch = normalizeVietnamese(search);
      const scoreRange = document.getElementById('scoreFilter').value;
      const groupBy = document.getElementById('groupBy').value;

      filteredEvaluations = allEvaluations.filter(e => {
        if (normalizedSearch && 
            !normalizeVietnamese(e.jd_name).includes(normalizedSearch) && 
            !normalizeVietnamese(e.cv_name).includes(normalizedSearch)) {
          return false;
        }
        if (scoreRange && e.score !== null) {
          const [min, max] = scoreRange.split('-').map(Number);
          if (e.score < min || e.score > max) return false;
        }
        return true;
      });

      currentPage = 1;
      renderResults(groupBy);
    }

    function renderResults(groupBy = '') {
      const container = document.getElementById('resultsContainer');
      const paginationContainer = document.getElementById('paginationContainer');

      if (filteredEvaluations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>No evaluations found</p>
          </div>
        `;
        paginationContainer.classList.add('hidden');
        return;
      }

      if (groupBy) {
        renderGrouped(groupBy);
        paginationContainer.classList.add('hidden');
      } else {
        renderList();
        renderPagination();
      }
    }

    function renderGrouped(groupBy) {
      const grouped = {};
      filteredEvaluations.forEach(e => {
        let key;
        if (groupBy === 'jd') key = e.jd_name;
        else if (groupBy === 'cv') key = e.cv_name;
        else if (groupBy === 'date') key = new Date(e.created_at).toLocaleDateString('vi-VN');
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(e);
      });

      const container = document.getElementById('resultsContainer');
      container.innerHTML = Object.entries(grouped).map(([key, items]) => `
        <div class="group-header">
          <span class="group-title">${key}</span>
          <span class="group-count">${items.length} evaluations</span>
        </div>
        <div class="eval-list">
          ${items.map(renderEvalItem).join('')}
        </div>
      `).join('');
    }

    function renderList() {
      const start = (currentPage - 1) * pageSize;
      const pageItems = filteredEvaluations.slice(start, start + pageSize);

      const container = document.getElementById('resultsContainer');
      container.innerHTML = `
        <div class="eval-list">
          ${pageItems.map(renderEvalItem).join('')}
        </div>
      `;
    }

    function renderEvalItem(e) {
      const scoreClass = e.score >= 8 ? 'high' : e.score >= 6 ? 'medium' : 'low';
      return `
        <div class="eval-item">
          <div class="eval-score ${scoreClass}">${e.score || '-'}</div>
          <div class="eval-info">
            <div class="eval-cv">${e.cv_name}</div>
            <div class="eval-jd">${e.jd_name}</div>
            <div class="eval-meta">
              ${e.jd_category ? `<span class="eval-tag">${e.jd_category}</span>` : ''}
              <span class="eval-tag">${new Date(e.created_at).toLocaleDateString('vi-VN')}</span>
            </div>
          </div>
          <div class="eval-actions">
            <a href="/report.html?id=${e.id}">View →</a>
          </div>
        </div>
      `;
    }

    function renderPagination() {
      const total = filteredEvaluations.length;
      const pages = Math.ceil(total / pageSize);
      const start = (currentPage - 1) * pageSize + 1;
      const end = Math.min(currentPage * pageSize, total);

      const paginationContainer = document.getElementById('paginationContainer');
      paginationContainer.classList.remove('hidden');

      let pagesHTML = '';
      const maxButtons = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = Math.min(pages, startPage + maxButtons - 1);

      for (let i = startPage; i <= endPage; i++) {
        pagesHTML += `
          <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>
        `;
      }

      paginationContainer.innerHTML = `
        <div class="pagination-info">${start}-${end} of ${total}</div>
        <div class="pagination-nav">
          <button class="pagination-btn" onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="bi bi-chevron-bar-left"></i>
          </button>
          <button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="bi bi-chevron-left"></i>
          </button>
          ${pagesHTML}
          <button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === pages ? 'disabled' : ''}>
            <i class="bi bi-chevron-right"></i>
          </button>
          <button class="pagination-btn" onclick="goToPage(${pages})" ${currentPage === pages ? 'disabled' : ''}>
            <i class="bi bi-chevron-bar-right"></i>
          </button>
        </div>
      `;
    }

    function goToPage(page) {
      currentPage = page;
      renderList();
      renderPagination();
    }

    document.getElementById('statsModal').addEventListener('click', (e) => {
      if (e.target.id === 'statsModal') closeStatsModal();
    });

    loadHistory();
  </script>
  <script src="/assets/js/settings.js?v=2"></script>
</body>
</html>
