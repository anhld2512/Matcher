<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compare | Matcher</title>
  <link rel="stylesheet" href="/assets/css/shared.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* Clean 2-Column Layout */
    .two-column-layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 2rem;
      min-height: calc(100vh - 180px);
    }
    
    @media (max-width: 1024px) {
      .two-column-layout {
        grid-template-columns: 1fr;
      }
    }

    /* Left Panel - Clean & Minimal */
    .left-panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .panel-section {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 1.25rem;
    }

    .section-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
      margin-bottom: 0.75rem;
    }

    /* JD Select - Simple */
    .jd-select-wrapper select {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 0.9375rem;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      background: white;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .jd-select-wrapper select:focus {
      outline: none;
      border-color: var(--gray-900);
    }

    /* JD Info Display */
    .jd-info {
      padding: 1rem;
      background: var(--gray-50);
      border-radius: 6px;
      margin-top: 1rem;
    }

    .jd-info-title {
      font-weight: 600;
      font-size: 0.9375rem;
      color: var(--gray-900);
      margin-bottom: 0.5rem;
    }

    .jd-info-meta {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .jd-tag {
      display: inline-block;
      padding: 0.25rem 0.625rem;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 4px;
      font-size: 0.75rem;
      color: var(--gray-600);
    }

    /* Custom Prompt - Clean Collapsible */
    .custom-prompt-section {
      border-top: 1px solid var(--gray-200);
      margin-top: 1rem;
      padding-top: 1rem;
    }

    .prompt-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      color: var(--gray-600);
      font-size: 0.8125rem;
    }

    .prompt-toggle:hover {
      color: var(--gray-900);
    }

    .prompt-toggle i {
      transition: transform 0.2s;
    }

    .prompt-toggle.active i {
      transform: rotate(180deg);
    }

    .prompt-content {
      display: none;
      margin-top: 0.75rem;
    }

    .prompt-content.active {
      display: block;
    }

    .prompt-textarea {
      width: 100%;
      min-height: 100px;
      padding: 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 0.8125rem;
      line-height: 1.5;
      resize: vertical;
      font-family: inherit;
    }

    .prompt-textarea:focus {
      outline: none;
      border-color: var(--gray-900);
    }

    .prompt-hint {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 0.5rem;
    }

    /* Right Panel - CV List */
    .right-panel {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .cv-header {
      padding: 1.25rem;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .cv-header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .cv-header-title {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .cv-count-badge {
      padding: 0.25rem 0.625rem;
      background: var(--gray-100);
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--gray-600);
    }

    .cv-count-badge.has-selection {
      background: var(--gray-900);
      color: white;
    }

    .cv-search {
      flex: 1;
      min-width: 200px;
      max-width: 300px;
    }

    .cv-search input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 0.8125rem;
    }

    .cv-search input:focus {
      outline: none;
      border-color: var(--gray-900);
    }

    /* CV List */
    .cv-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .cv-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
      margin-bottom: 0.25rem;
    }

    .cv-item:hover {
      background: var(--gray-50);
    }

    .cv-item.selected {
      background: var(--gray-100);
    }

    .cv-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--gray-300);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
    }

    .cv-item.selected .cv-checkbox {
      background: var(--gray-900);
      border-color: var(--gray-900);
    }

    .cv-checkbox i {
      font-size: 0.75rem;
      color: white;
      opacity: 0;
    }

    .cv-item.selected .cv-checkbox i {
      opacity: 1;
    }

    .cv-item-info {
      flex: 1;
      min-width: 0;
    }

    .cv-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--gray-900);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cv-type {
      font-size: 0.75rem;
      color: var(--gray-500);
    }

    /* Footer Actions */
    .cv-footer {
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--gray-50);
    }

    .clear-btn {
      background: none;
      border: none;
      color: var(--gray-600);
      font-size: 0.8125rem;
      cursor: pointer;
      padding: 0.5rem;
    }

    .clear-btn:hover {
      color: var(--gray-900);
    }

    .compare-btn {
      padding: 0.625rem 1.5rem;
      background: var(--gray-900);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: opacity 0.2s;
    }

    .compare-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .compare-btn:not(:disabled):hover {
      opacity: 0.9;
    }

    /* Empty State */
    .empty-state {
      padding: 3rem 1rem;
      text-align: center;
      color: var(--gray-400);
    }

    .empty-state i {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    /* Modal - Minimal */
    .modal-content {
      border-radius: 8px;
    }

    .modal-header-simple {
      padding: 1.25rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .modal-title-simple {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
      margin: 0;
    }

    .progress-bar {
      height: 4px;
      background: var(--gray-200);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--gray-900);
      transition: width 0.3s;
    }

    .result-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }

    .result-cv-name {
      font-weight: 500;
      color: var(--gray-900);
    }

    .result-score {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .result-score.high { color: #16a34a; }
    .result-score.medium { color: #ca8a04; }
    .result-score.low { color: #dc2626; }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <i class="bi bi-diagram-3"></i>
          Matcher
        </a>
      </div>
      <nav class="sidebar-nav">
        <a href="/" class="nav-item active">
          <i class="bi bi-bar-chart"></i>
          <span>Compare</span>
        </a>
        <a href="/jd-management.html" class="nav-item">
          <i class="bi bi-file-earmark-text"></i>
          <span>JD Management</span>
        </a>
        <a href="/cv-management.html" class="nav-item">
          <i class="bi bi-person-badge"></i>
          <span>CV Management</span>
        </a>
        <a href="/history.html" class="nav-item">
          <i class="bi bi-clock-history"></i>
          <span>History</span>
        </a>
        <div style="flex: 1;"></div>
        <a href="#" class="nav-item" onclick="openAiSettingsModal()">
          <i class="bi bi-gear"></i>
          <span>AI Settings</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <header class="header">
        <button class="mobile-menu-toggle" onclick="toggleSidebar()">
          <i class="bi bi-list"></i>
        </button>
        <h1 class="header-title">CV Evaluation</h1>
        <div class="header-toolbar">
          <button class="btn btn-outline" onclick="refreshData()">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </header>

      <!-- Content -->
      <main class="content">
        <div class="two-column-layout">
          <!-- Left Panel -->
          <div class="left-panel">
            <!-- JD Selection -->
            <div class="panel-section">
              <div class="section-label">Job Description</div>
              <div class="jd-select-wrapper">
                <select id="jdSelect" onchange="loadJDPreview()">
                  <option value="">Select a JD...</option>
                </select>
              </div>
              
              <!-- JD Info -->
              <div id="jdInfo" class="jd-info hidden">
                <div class="jd-info-title" id="jdTitle"></div>
                <div class="jd-info-meta">
                  <span class="jd-tag" id="jdCategory"></span>
                  <span class="jd-tag" id="jdDepartment"></span>
                </div>
              </div>

              <!-- Custom Prompt -->
              <div id="customPromptSection" class="custom-prompt-section hidden">
                <button class="prompt-toggle" onclick="toggleCustomPrompt()" id="promptToggle">
                  <span>Custom prompt (optional)</span>
                  <i class="bi bi-chevron-down"></i>
                </button>
                <div class="prompt-content" id="promptContent">
                  <textarea 
                    id="customPrompt" 
                    class="prompt-textarea" 
                    placeholder="Add specific requirements for AI evaluation..."></textarea>
                  <div class="prompt-hint">
                    These requirements will be combined with JD criteria.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Panel -->
          <div class="right-panel">
            <div class="cv-header">
              <div class="cv-header-left">
                <span class="cv-header-title">Candidates</span>
                <span class="cv-count-badge" id="cvCountBadge">0 selected</span>
              </div>
              <div class="cv-search">
                <input type="text" id="cvSearch" placeholder="Search..." oninput="filterCVs()">
              </div>
            </div>

            <div class="cv-list" id="cvList">
              <div class="empty-state">
                <i class="bi bi-hourglass"></i>
                <p>Loading...</p>
              </div>
            </div>

            <div class="cv-footer">
              <button class="clear-btn" onclick="clearSelection()">
                Clear selection
              </button>
              <button class="compare-btn" id="compareBtn" disabled onclick="runEvaluation()">
                <i class="bi bi-play-fill"></i>
                Run Evaluation
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Progress Modal -->
  <div id="progressModal" class="modal">
    <div class="modal-content" style="max-width: 480px;">
      <div class="modal-header-simple">
        <h3 class="modal-title-simple" id="modalTitle">Evaluating...</h3>
      </div>
      <div class="modal-body" style="padding: 1.5rem;">
        <div id="progressSection">
          <div class="progress-bar" style="margin-bottom: 1rem;">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
          </div>
          <p id="progressText" style="font-size: 0.875rem; color: var(--gray-600); text-align: center; margin: 0;">
            Sending request...
          </p>
        </div>

        <div id="resultsSection" class="hidden">
          <div id="results"></div>
        </div>
      </div>
      <div id="modalFooter" class="modal-footer hidden" style="padding: 1rem 1.5rem; border-top: 1px solid var(--gray-200);">
        <button class="btn btn-outline" onclick="closeProgressModal()">Close</button>
        <a href="/history.html" class="btn btn-primary">View History</a>
      </div>
    </div>
  </div>

  <script>
    const MAX_CVS = 10;
    let selectedCVs = new Set();
    let allCVs = [];
    let currentJD = null;

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    function toggleCustomPrompt() {
      const toggle = document.getElementById('promptToggle');
      const content = document.getElementById('promptContent');
      toggle.classList.toggle('active');
      content.classList.toggle('active');
    }

    // Normalize Vietnamese text for search (remove diacritics)
    function normalizeVietnamese(str) {
      return str
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/đ/g, 'd')
        .replace(/Đ/g, 'D');
    }

    async function loadJDs() {
      const res = await fetch('/jds');
      const data = await res.json();
      const select = document.getElementById('jdSelect');
      select.innerHTML = '<option value="">Select a JD...</option>';

      if (data.items) {
        data.items.forEach(jd => {
          const opt = document.createElement('option');
          opt.value = jd.name;
          opt.textContent = jd.name;
          select.appendChild(opt);
        });
      }
    }

    async function loadJDPreview() {
      const jdName = document.getElementById('jdSelect').value;
      const info = document.getElementById('jdInfo');
      const promptSection = document.getElementById('customPromptSection');
      const promptToggle = document.getElementById('promptToggle');
      const promptContent = document.getElementById('promptContent');
      
      if (!jdName) {
        info.classList.add('hidden');
        promptSection.classList.add('hidden');
        promptToggle.classList.remove('active');
        promptContent.classList.remove('active');
        currentJD = null;
        updateButton();
        return;
      }

      currentJD = jdName;
      document.getElementById('jdTitle').textContent = jdName;
      document.getElementById('jdCategory').textContent = 'Uncategorized';
      document.getElementById('jdDepartment').textContent = 'General';
      info.classList.remove('hidden');
      promptSection.classList.remove('hidden');
      // Auto-expand custom prompt
      promptToggle.classList.add('active');
      promptContent.classList.add('active');
      updateButton();
    }

    async function loadCVs() {
      const res = await fetch('/cvs');
      const data = await res.json();

      if (!data.items || data.items.length === 0) {
        document.getElementById('cvList').innerHTML = `
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>No CVs uploaded yet</p>
          </div>
        `;
        return;
      }

      allCVs = data.items;
      renderCVList();
    }

    function renderCVList() {
      const searchQuery = document.getElementById('cvSearch').value;
      const normalizedQuery = normalizeVietnamese(searchQuery);
      const filteredCVs = allCVs.filter(cv => {
        const normalizedName = normalizeVietnamese(cv.name);
        return normalizedName.includes(normalizedQuery);
      });
      const list = document.getElementById('cvList');

      if (filteredCVs.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-search"></i>
            <p>No results found</p>
          </div>
        `;
        return;
      }

      list.innerHTML = filteredCVs.map(cv => {
        const isSelected = selectedCVs.has(cv.name);
        return `
          <div class="cv-item ${isSelected ? 'selected' : ''}" onclick="toggleCV('${cv.name}')">
            <div class="cv-checkbox">
              <i class="bi bi-check"></i>
            </div>
            <div class="cv-item-info">
              <div class="cv-name">${cv.name}</div>
              ${cv.type ? `<div class="cv-type">${cv.type}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');

      updateSelectedCount();
    }

    function toggleCV(name) {
      if (selectedCVs.has(name)) {
        selectedCVs.delete(name);
      } else if (selectedCVs.size < MAX_CVS) {
        selectedCVs.add(name);
      }
      renderCVList();
      updateButton();
    }

    function clearSelection() {
      selectedCVs.clear();
      renderCVList();
      updateButton();
    }

    function filterCVs() {
      renderCVList();
    }

    function updateSelectedCount() {
      const badge = document.getElementById('cvCountBadge');
      const count = selectedCVs.size;
      badge.textContent = count === 0 ? '0 selected' : `${count} selected`;
      badge.classList.toggle('has-selection', count > 0);
    }

    function updateButton() {
      document.getElementById('compareBtn').disabled = !currentJD || selectedCVs.size === 0;
    }

    function refreshData() {
      loadJDs();
      loadCVs();
    }

    function closeProgressModal() {
      document.getElementById('progressModal').classList.remove('active');
      document.getElementById('progressSection').classList.remove('hidden');
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('modalFooter').classList.add('hidden');
      document.getElementById('progressFill').style.width = '0%';
    }

    async function runEvaluation() {
      const cvs = Array.from(selectedCVs);

      document.getElementById('progressModal').classList.add('active');
      document.getElementById('modalTitle').textContent = 'Evaluating...';
      document.getElementById('progressSection').classList.remove('hidden');
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('modalFooter').classList.add('hidden');
      document.getElementById('progressFill').style.width = '0%';
      document.getElementById('progressText').textContent = 'Sending request...';

      const compareBtn = document.getElementById('compareBtn');
      compareBtn.disabled = true;

      try {
        const customPrompt = document.getElementById('customPrompt').value.trim();
        const payload = { jd_name: currentJD, cv_names: cvs };
        if (customPrompt) payload.custom_prompt = customPrompt;
        
        const res = await fetch('/evaluate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        pollStatus(data.task_id);
      } catch (e) {
        alert('Error: ' + e.message);
        closeProgressModal();
        updateButton();
      }
    }

    async function pollStatus(taskId) {
      let progressValue = 0;
      const interval = setInterval(async () => {
        const res = await fetch(`/tasks/${taskId}`);
        const data = await res.json();

        progressValue = Math.min(95, progressValue + Math.random() * 10);
        document.getElementById('progressFill').style.width = progressValue + '%';

        const statusMap = {
          'queued': 'Waiting in queue...',
          'started': 'Analyzing CVs...',
          'finished': 'Done!',
          'failed': 'Error occurred'
        };
        document.getElementById('progressText').textContent = statusMap[data.status] || data.status;

        if (data.status === 'finished') {
          clearInterval(interval);
          document.getElementById('progressFill').style.width = '100%';
          setTimeout(() => showResults(data.result), 500);
        } else if (data.status === 'failed') {
          clearInterval(interval);
          alert('Evaluation failed');
          closeProgressModal();
          updateButton();
        }
      }, 1500);
    }

    function showResults(data) {
      document.getElementById('progressSection').classList.add('hidden');
      document.getElementById('resultsSection').classList.remove('hidden');
      document.getElementById('modalFooter').classList.remove('hidden');
      document.getElementById('modalTitle').textContent = 'Results';
      
      const results = document.getElementById('results');
      results.innerHTML = data.results.map(r => {
        const scoreClass = r.score >= 8 ? 'high' : r.score >= 6 ? 'medium' : 'low';
        return `
          <div class="result-item">
            <div>
              <div class="result-cv-name">${r.cv}</div>
              <a href="/report.html?id=${r.evaluation_id}" style="font-size: 0.75rem; color: var(--gray-500);">View report →</a>
            </div>
            <div class="result-score ${scoreClass}">${r.score}</div>
          </div>
        `;
      }).join('');
      
      updateButton();
    }

    loadJDs();
    loadCVs();
  </script>

  <script src="/assets/js/settings.js?v=2"></script>
</body>
</html>
